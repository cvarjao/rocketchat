# Operations Manual

## File/Folder structure
  - `.openshift/` contains openshift templates generated by `create-templates.sh`
  - `.portable/` contains a few utilities (e.g.: `helm`, `oc`, `jq`) wrapper that were "vendored" and sandboxed/locked to specific versions
  - `create-templates.sh` creates openshift templates based on helm charts
  - `apply-templates.sh` apply the generate template


## Prerequisites
  make sure you have properly loggedin using (`oc login`), and the current project has been defined to the correct one (`oc project <name>`)
  ```
  oc login <openshift-cluster-url> --token=<hidden>
  oc project <name>
  ```

## Installation
  From a bash terminal run:
  ```
  create-templates.sh && apply-templates.sh
  ```

## Update/upgrade?
  Be careful with updates/upgrades.
  If there are database changes, we should scale rocketchat down to 1 replica to avoid a concurrency problem where multiple pods will try to perform database migration at the same time.
  ```
  # scale rocketchat down to 1 replicas
  oc scale deployment/rocketchat-prod-rocketchat --replicas=1
  # Review and update chart versions and/or image tags
  create-templates.sh
  # Review changes applied to '.openshift'
  apply-templates.sh
  ```

## Uninstall
```
oc delete all,svc,secret,pvc -l 'app.kubernetes.io/part-of=rocketchat-prod'
```

## Backup

We only need to take backups of the MongoDB database. A CronJob runs on a nightly (midnight) basis for taking backups.

You can manually trigger a backup by running:
```
oc create job "manual-mongodb-backup-$(date +%s)" --from=cronjob/rocketchat-prod-mongodb-backup
```

## Restore
Before you start restoring MongoDB from a backup, be sure that is what you want!
WARNING: Restoring from a backup archive MAY cause data loss!!
TODO: Create a script automating the restore procedure

For restoring RocketChat database to a previous state you will need to :
  1. Take RocketChat down:

    ```
    oc scale deployment/rocketchat-prod-rocketchat --replicas=0
    # wait until  there is no pods running
    ```
    WARNING: This will cause an outage!!!

  2. Scale MongoDB down:

    ```
    oc scale deployment/rocketchat-prod-mongodb-arbiter   --replicas=0
    oc scale deployment/rocketchat-prod-mongodb-secondary --replicas=0
    oc scale deployment/rocketchat-prod-mongodb-primary   --replicas=0
    ```

  3. Delete all MongoDB PVCs, except the backup PVC

    ```
    oc delete pvc -l 'app.kubernetes.io/name=mongodb,!backup'
    ```

  4. Temporarily mount the backup volume

    ```
    oc set volumes StatefulSet/rocketchat-prod-mongodb-primary --add --name=backup --mount-path=/media/backup --type=pvc --claim-name=rocketchat-prod-mongodb-backup
    ```

  5. Scale MongoDB primary up, and restore from a remote shell

    Scale MongoDB to 1 primary replica:

    ```
    oc scale StatefulSet/rocketchat-prod-mongodb-primary --replicas=1
    # Verify that the StatefulSet has been succesfully started, and a PVC has been recreated for the 1st replica
    ```
    Connect to a remote/pod terminal of the first replica of primary MongoDB

    ```
    oc rsh pod/rocketchat-prod-mongodb-primary-0
    ```
    and run:

    ```
    #Find the backup archive you want to restore:
    ls -1 /media/backup/ | sort | tail -n10

    # Now that you know which backup archive you want to restore, let's restore it
    mongorestore --gzip --archive=/media/backup/rocketchat-[timestamp].gz "--username=root" "--password=${MONGODB_ROOT_PASSWORD}" '--authenticationDatabase=admin'
    
    # You may use 'nsFrom' and 'nsTo' for restoring to a new database name: 
    # e.g.: '--nsFrom=rocketchat.*' '--nsTo=rocketchat-restored.*'

    # wait until backup is complete!
    ```

  7. Remove temporary mount of the backup volume

    ```
    oc set volumes StatefulSet/rocketchat-prod-mongodb-primary --remove --name=backup
    ```

  8. Scale RocketChat and other MongoDB StatefulSets

    ```
    oc scale deployment/rocketchat-prod-mongodb-arbiter   --replicas=1
    oc scale deployment/rocketchat-prod-mongodb-secondary --replicas=1
    oc scale deployment/rocketchat-prod-rocketchat --replicas=1

    # After 1 replica has been sucessfully started, you may restore the original number of replicas (e.g.: 3)
    ```
## Regular maintenance/admin tasks
The following tasks has not been automated yet, and should be automate in the near future

- On a weekly basis check the backup PVC to make sure it is healthy and has enough space available.
- prune/delete old archive backups